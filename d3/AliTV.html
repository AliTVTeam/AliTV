<html>
<title>AliTV</title>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="lib/jquery-ui-1.9.2.custom.min.css">
<link rel="stylesheet" href="css/AliTV.css">
<link rel="shortcut icon" href="css/AliTV_logo.ico" />
<link href="lib/bootstrap.min.css" rel="stylesheet">
<link href="lib/colorpicker/bootstrap-colorpicker.min.css" rel="stylesheet">
<link href="lib/jsoneditor.min.css" rel="stylesheet" type="text/css">
    
<script src="lib/d3.v3.min.js"></script>
<script src="lib/jquery.min.js"></script>
<script src="lib/jquery-ui.min.js"></script>
<script src="lib/FileSaver.min.js"></script>
<script src="lib/jsoneditor.min.js"></script>

<script src="js/AliTV.js"></script>
<script src="lib/bootstrap.min.js"></script>
<script src="lib/colorpicker/bootstrap-colorpicker.min.js"></script>
<script src="lib/textures.min.js"></script> 
<script type="text/javascript">
	var ali;
	var editor;
	$(document).ready(function() {
		var svg = $('#wgaCanvas');
		ali = new AliTV(svg);
		var container = document.getElementById("jsoneditor");
		editor = new JSONEditor(container)
		$.getJSON('data/data.json', function(data) {
			ali.setData(data.data);
			$.getJSON('data/filters.json', function(filters) {
				ali.setFilters(filters.filters);
				$.getJSON('data/conf.json', function(conf) {
					ali.setConf(conf.conf)
					setJSONEditorFromAli();
					ali.drawLinear();
				}).fail(function() {
				    console.log( "could not load custom conf.json - using default values" );
				    setJSONEditorFromAli();
				    ali.drawLinear();
				});
			});
		});	
	});	
	
	$('#loadJSON').on('change', function(evt) {
		var files = evt.target.files; // FileList object
	    // files is a FileList of File objects.
	    var output = [];
	    for (var i = 0, f; f = files[i]; i++) {
	    	var fr = new FileReader();
	    	fr.onload = function(x){
	    		ali.setJSON(JSON.parse(x.target.result));
	    		setJSONEditorFromAli();
	    		ali.drawLinear();
	    	}
	    	fr.readAsText(f);
	    }
	});

	//prevent folding of accordion on click on apply
	$("#applyChanges").unbind("click");
	$('#applyChanges').on('click', function(evt) {
		evt.stopPropagation();
		evt.preventDefault();
		setNewParameters();
	});
	
	function setAliFromJSONEditor(){
		var json = editor.get();
		ali.setJSON(json);
		ali.drawEqualLayout(ali.getLayout());
	}
	function setJSONEditorFromAli(){
		editor.set(ali.getJSON());
	}
	function toggleJSONEditor(){
		$('#jsoneditor').toggle();
	}
	function saveSVG(){
	    var blob = new Blob([ali.getSvgAsText()], {type: "image/svg+xml;charset=utf-8"});
	    saveAs(blob, "AliTV.svg");
	}
	function saveJSON(){
	    var blob = new Blob([JSON.stringify(ali.getJSON())], {type: "plain/text;charset=utf-8"});
	    saveAs(blob, "AliTV.json");
	}
	
	
 	$('#myTabs a').click(function (e) {
		  e.preventDefault()
		  $(this).tab('show')
	});
	
	$('#myTabs a[href="#profile"]').tab('show') // Select tab by name
	$('#myTabs a:first').tab('show') // Select first tab
	$('#myTabs a:last').tab('show') // Select last tab
	$('#myTabs li:eq(2) a').tab('show') // Select third tab (0-indexed)
	
	$('.dropdown-toggle').dropdown()
	
	$(function(){
		$("#identity-slider").slider({
			range: true,
			values: [0, 100],
			min: 0,
			max: 100,
			slide: function(event, ui){
				$("#identity-label").val(ui.values[0] + " % - " + ui.values[1] + " %");
				ali.filters.links.minLinkIdentity = ui.values[0];
				ali.filters.links.maxLinkIdentity = ui.values[1];
			}
		});	
		$("#identity-label").val($("#identity-slider").slider("values", 0) + " % - " + $("#identity-slider").slider("values", 1) + " %");
		
		$("#length-slider").slider({
			range: true,
			values: [100, 1000],
			min: 100,
			max: 1000,
			slide: function(event, ui){
				$("#minlength-label").val(ui.values[0] + " bp - " + ui.values[1] + " bp");
				ali.filters.links.minLinkLength = ui.values[0];
				ali.filters.links.maxLinkLength = ui.values[1];
				}
		});
		$("#minlength-label").val($("#length-slider").slider("values", 0) + " bp - " + $("#length-slider").slider("values", 1) + " bp");
	});
</script>
</head>
<body>

<div class="page-header">
  <h1><img src="css/AliTV_logo.svg" alt="logo" width="90" height="90" style="margin:0px 20px"/>AliTV <small>Visualize multiple whole genome alignments as circular or linear maps</small></h1>
<div>

  <ul class="nav nav-tabs" role="tablist">
  
  	<li role="presentation"><a href="#about" aria-controls="about" role="tab" data-toggle="tab">About AliTV</a></li>
  	<li class="dropdown"><a href="#toolbox" class="dropdown-toggle" data-toggle="dropdown">Toolbox & Analysis <span class="caret"></span></a>
  		<ul class="dropdown-menu" aria-labelledby="dLabel">
	    	<li><a href="#filter" data-toggle="tab">Filtering</a></li>
	    	<li><a href="#features" data-toggle="tab">Features</a></li>
	    	<li><a href="#tree" data-toggle="tab">PhylogeneticTree</a></li>
    	</ul> 
  	</li>
  	
  	<li role="presentation"><a href="#graphicalSettings" aria-controls="graphicalSettings" role="tab" data-toggle="tab">Layout Settings</a></li>
  	<li role="presentation"><a href="#advancedSettings" aria-controls="advancedSettings" role="tab" data-toggle="tab">Advanced Settings</a></li>
    <li role="presentation"><a href="#importExport" aria-controls="importExport" role="tab" data-toggle="tab">Import & Export</a></li>  
</ul>

  <div class="tab-content">
	<div role="tabpanel" class="tab-pane active" id="about" style="margin:10px 10px">
		AliTV (Alignment Toolbox and Visualization)
	</div>
    <div role="tabpanel" class="tab-pane fade" id="advancedSettings" style="margin:10px 10px"> 
    	By using JSONEditor You can change all parameters directly in the structure of the conf-, data- or filters-object. <br> 
    	<div style="margin: 10px 0px">
		  <button class="btn btn-info" onclick="toggleJSONEditor()">Toggle JSON Editor</button>
		  <button class="btn btn-info" onclick="setAliFromJSONEditor()">Apply JSON Editor content</button>
		</div>
	</div>
	<div role="tabpanel" class="tab-pane fade" id="importExport" style="margin:10px 10px"> 
    	<div style="margin: 10px 0px">
		  <button class="btn btn-info" onclick="saveSVG()">Save SVG</button>
		  <button class="btn btn-info" onclick="saveJSON()">Save JSON</button>
		  <button class="btn btn-info" onclick="$('#loadJSON').click()">Load JSON</button>
		  <input type="file" id="loadJSON" name="files[]" style="display:none" multiple></input>
		</div>
	</div>
	<div role="tabpanel" class="tab-pane fade" id="graphicalSettings" style="margin:10px 10px">
		Layout Settings
	</div>
	<div role="tabpanel" class="tab-pane fade" id="filter" style="margin:10px 10px">
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-6">
					Filter links by their identity:
					<p>
 						<label for="identity-label">Identity range:</label> 
 						<input type="text"id="identity-label" readonly>
 					</p>
 					<div id="identity-slider"></div>
				</div>
				<div class="col-sm-6">
					Filter links by their length:
				</div>
			</div>
		</div>
	</div>
	<div role="tabpanel" class="tab-pane fade" id="tree" style="margin:10px 10px">
		Add a phylogenetic tree.
	</div>
	<div role="tabpanel" class="tab-pane fade" id="features" style="margin:10px 10px">
		Add biological features.
	</div>
  </div>

</div>
</div>

<div style="width: 100%; overflow: hidden;">
 	<svg id='wgaCanvas' style="margin:50px"></svg>
 </div> 

 <div id="jsoneditor" style="display:none"></div>
 </body>
 </html>
 
 



